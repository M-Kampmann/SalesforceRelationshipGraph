<template>
    <lightning-card title="Relationship Graph" icon-name="custom:custom15">
        <!-- Toolbar -->
        <div slot="actions">
            <lightning-button-group>
                <lightning-button
                    label="Refresh"
                    icon-name="utility:refresh"
                    onclick={handleRefresh}
                    disabled={isLoading}>
                </lightning-button>
                <lightning-button
                    label={hidePassiveLabel}
                    icon-name={hidePassiveIcon}
                    onclick={toggleHidePassive}
                    variant={hidePassiveVariant}>
                </lightning-button>
                <lightning-button
                    label={showExternalLabel}
                    icon-name="utility:world"
                    onclick={toggleExternalContacts}
                    variant={showExternalVariant}>
                </lightning-button>
            </lightning-button-group>
        </div>

        <!-- Filter (color-coded badges = legend) -->
        <div class="filter-legend">
            <template for:each={classificationFilters} for:item="filter">
                <span
                    key={filter.value}
                    class={filter.cssClass}
                    style={filter.badgeStyle}
                    onclick={handleFilterClick}
                    data-classification={filter.value}>
                    {filter.label}
                </span>
            </template>
            <template if:true={showExternalContacts}>
                <span class="filter-badge external-contact-badge"
                      style="background-color: #00897b; color: #fff;">
                    External ({externalContactCount})
                </span>
            </template>
            <lightning-input
                class="threshold-control"
                type="number"
                label="Min"
                min="0"
                max="20"
                value={minInteractions}
                onchange={handleThresholdChange}
                step="1"
                variant="label-inline">
            </lightning-input>
        </div>

        <!-- Main Content -->
        <div class="graph-container">
            <!-- Loading Spinner -->
            <template if:true={isLoading}>
                <lightning-spinner alternative-text="Loading graph..." size="large">
                </lightning-spinner>
            </template>

            <!-- Graph Canvas -->
            <div class="canvas-wrapper" lwc:dom="manual" lwc:ref="canvasContainer">
            </div>

            <!-- Zoom Controls -->
            <div class="zoom-controls">
                <lightning-button-icon
                    icon-name="utility:add"
                    alternative-text="Zoom in"
                    onclick={handleZoomIn}
                    size="small"
                    variant="border-filled">
                </lightning-button-icon>
                <lightning-button-icon
                    icon-name="utility:dash"
                    alternative-text="Zoom out"
                    onclick={handleZoomOut}
                    size="small"
                    variant="border-filled">
                </lightning-button-icon>
                <lightning-button-icon
                    icon-name="utility:home"
                    alternative-text="Reset zoom"
                    onclick={handleZoomReset}
                    size="small"
                    variant="border-filled">
                </lightning-button-icon>
            </div>

            <!-- Risk Alert Panel -->
            <template if:true={showRiskPanel}>
                <div class="risk-panel">
                    <div class="risk-panel-header">
                        <span class="risk-panel-title">Risk Alerts ({riskAlertCount})</span>
                        <lightning-button-icon
                            icon-name="utility:close"
                            alternative-text="Close"
                            onclick={closeRiskPanel}
                            size="small">
                        </lightning-button-icon>
                    </div>
                    <div class="risk-panel-body">
                        <template for:each={riskAlerts} for:item="alert">
                            <div
                                key={alert.key}
                                class={alert.severityClass}
                                data-contact-id={alert.contactId}
                                onclick={handleRiskAlertClick}>
                                <span class="risk-icon">{alert.severityIcon}</span>
                                <div class="risk-text">
                                    <span class="risk-type">{alert.riskType}</span>
                                    <span class="risk-message">{alert.message}</span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Node Detail Panel (slide-in) -->
            <template if:true={selectedNode}>
                <div class="detail-panel">
                    <div class="detail-header">
                        <h3>{selectedNode.name}</h3>
                        <lightning-button-icon
                            icon-name="utility:close"
                            alternative-text="Close"
                            onclick={closeDetailPanel}
                            size="small">
                        </lightning-button-icon>
                    </div>
                    <div class="detail-body">
                        <template if:true={selectedNode.title}>
                            <p class="detail-field">
                                <span class="detail-label">Title</span>
                                <span class="detail-value">{selectedNode.title}</span>
                            </p>
                        </template>
                        <template if:true={selectedNode.email}>
                            <p class="detail-field">
                                <span class="detail-label">Email</span>
                                <span class="detail-value">{selectedNode.email}</span>
                            </p>
                        </template>
                        <!-- Contact: Classification badge -->
                        <template if:true={isContactNode}>
                            <template if:true={selectedNode.classification}>
                                <p class="detail-field">
                                    <span class="detail-label">Classification</span>
                                    <lightning-badge
                                        label={selectedNode.classification}
                                        class={selectedNodeClassificationClass}>
                                    </lightning-badge>
                                    <template if:true={selectedNode.confidence}>
                                        <span class="confidence-score">
                                            ({formattedConfidence}% confidence)
                                        </span>
                                    </template>
                                </p>
                            </template>
                        </template>
                        <!-- External Contact: Account info -->
                        <template if:true={isExternalContactNode}>
                            <template if:true={selectedNode.accountName}>
                                <p class="detail-field">
                                    <span class="detail-label">Account</span>
                                    <span class="detail-value">{selectedNode.accountName}</span>
                                </p>
                            </template>
                            <p class="detail-field">
                                <span class="detail-label">Type</span>
                                <span class="detail-value">External Contact</span>
                            </p>
                        </template>
                        <!-- Opportunity: Stage, Amount, Close Date -->
                        <template if:true={isOpportunityNode}>
                            <p class="detail-field">
                                <span class="detail-label">Stage</span>
                                <span class="detail-value">{selectedNode.classification}</span>
                            </p>
                            <template if:true={formattedAmount}>
                                <p class="detail-field">
                                    <span class="detail-label">Amount</span>
                                    <span class="detail-value">{formattedAmount}</span>
                                </p>
                            </template>
                            <template if:true={formattedCloseDate}>
                                <p class="detail-field">
                                    <span class="detail-label">Close Date</span>
                                    <span class="detail-value">{formattedCloseDate}</span>
                                </p>
                            </template>
                        </template>
                        <template if:true={selectedNode.interactionCount}>
                            <p class="detail-field">
                                <span class="detail-label">Interactions</span>
                                <span class="detail-value">{selectedNode.interactionCount}</span>
                            </p>
                        </template>
                        <template if:true={selectedNode.coOccurrenceCount}>
                            <p class="detail-field">
                                <span class="detail-label">Co-occurrences</span>
                                <span class="detail-value">{selectedNode.coOccurrenceCount}</span>
                            </p>
                        </template>

                        <!-- Strength Reason -->
                        <template if:true={selectedNode.strengthReason}>
                            <p class="detail-field">
                                <span class="detail-label">Connection Insight</span>
                                <span class="detail-value detail-reason">{selectedNode.strengthReason}</span>
                            </p>
                        </template>

                        <!-- Score Breakdown -->
                        <template if:true={hasStrengthFactors}>
                            <div class="factor-breakdown">
                                <span class="detail-label">Score Breakdown</span>
                                <template for:each={strengthFactors} for:item="factor">
                                    <div key={factor.key} class="factor-row">
                                        <div class="factor-info">
                                            <span class="factor-name">{factor.name}</span>
                                            <template if:true={factor.category}>
                                                <span class="factor-category">{factor.category}</span>
                                            </template>
                                        </div>
                                        <div class="factor-bar-container">
                                            <div class="factor-bar" style={factor.barStyle}></div>
                                        </div>
                                        <span class="factor-value">{factor.formattedContribution}</span>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- Classification Override -->
                        <template if:true={isContactNode}>
                            <div class="override-section">
                                <lightning-combobox
                                    label="Override Classification"
                                    value={selectedNode.classification}
                                    options={classificationOptions}
                                    onchange={handleClassificationOverride}>
                                </lightning-combobox>
                            </div>
                        </template>

                        <!-- Navigate to Record -->
                        <div class="detail-actions">
                            <lightning-button
                                label="View Record"
                                variant="brand"
                                onclick={navigateToRecord}
                                icon-name="utility:new_window">
                            </lightning-button>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar" slot="footer">
            <span>Nodes: {nodeCount}</span>
            <span>Edges: {edgeCount}</span>
            <template if:true={hidePassive}>
                <span>Hidden: {hiddenCount} passive contacts</span>
            </template>
            <template if:true={showExternalContacts}>
                <span>External: {externalContactCount}</span>
            </template>
            <template if:true={isTruncated}>
                <span class="truncation-warning">Showing 500 of {totalContactCount}+ contacts</span>
            </template>
            <template if:true={hasRiskAlerts}>
                <lightning-button
                    label={riskAlertButtonLabel}
                    variant={riskAlertButtonVariant}
                    icon-name="utility:warning"
                    onclick={handleRiskAlertToggle}
                    class="risk-alert-button">
                </lightning-button>
            </template>
        </div>
    </lightning-card>
</template>
